<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourly Car Traffic Line Chart</title>
    <h1>Hourly Car Traffic Line Chart</h1>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .hidden {
            display: none;
        }

        .chart-title {
            cursor: pointer;
        }

        .active {
            font-weight: bold;
            color: #4CAF50;
            /* Green color for active state */
            text-decoration: underline;
        }

        .button-active {
            background-color: #4CAF50;
            /* Green background for active button */
            color: white;
        }
    </style>
</head>

<body>
    <div>
        <label for="carType">Choose a car type:</label>
    </div>
    <div id="buttons"></div>
    <div id="chart"></div>
    <div id="status"></div>

    <script>
        const width = 960;
        const height = 500;
        const margin = { top: 20, right: 20, bottom: 50, left: 50 };

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        d3.json("sensor_data_per_ID.json").then(function (jsonData) {
            const carTypes = new Set();
            const dataByTypeAndHour = new Map();

            Object.entries(jsonData).forEach(([key, value]) => {
                const carType = value["car-type"];
                carTypes.add(carType);
                if (!dataByTypeAndHour.has(carType)) {
                    dataByTypeAndHour.set(carType, new Map());
                }
                Object.entries(value.route).forEach(([date, events]) => {
                    events.forEach(event => {
                        const hour = Object.keys(event)[0].slice(0, 2); // Extract hour from time
                        const hourMap = dataByTypeAndHour.get(carType);
                        hourMap.set(hour, (hourMap.get(hour) || 0) + 1);
                    });
                });
            });

            const buttonContainer = document.getElementById("buttons");
            buttonContainer.innerHTML = '';
            carTypes.forEach(type => {
                const button = document.createElement("button");
                button.innerText = type;
                button.className = 'button';
                button.addEventListener('click', function () {
                    document.querySelectorAll('.button').forEach(b => b.classList.remove('button-active'));
                    this.classList.add('button-active');
                    updateChart(type);
                });
                buttonContainer.appendChild(button);
            });

            function updateChart(carType) {
                const dataByHour = dataByTypeAndHour.get(carType);
                const data = Array.from(dataByHour, ([hour, count]) => ({ hour, count }))
                    .sort((a, b) => a.hour.localeCompare(b.hour));

                const xScale = d3.scaleBand()
                    .domain(data.map(d => d.hour))
                    .range([0, width])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.count)])
                    .range([height, 0]);

                svg.selectAll(".line").remove();
                svg.selectAll(".axis").remove();
                svg.selectAll(".peak-mark").remove();
                svg.selectAll(".peak-text").remove();

                const lineGenerator = d3.line()
                    .x(d => xScale(d.hour) + xScale.bandwidth() / 2)
                    .y(d => yScale(d.count));

                svg.append("path")
                    .data([data])
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 2)
                    .attr("d", lineGenerator);

                const peak = data.reduce((a, b) => a.count > b.count ? a : b);

                svg.append("circle")
                    .attr("class", "peak-mark")
                    .attr("cx", xScale(peak.hour) + xScale.bandwidth() / 2)
                    .attr("cy", yScale(peak.count))
                    .attr("r", 5)
                    .attr("fill", "red");

                svg.append("text")
                    .attr("class", "peak-text")
                    .attr("x", xScale(peak.hour) + xScale.bandwidth() / 2)
                    .attr("y", yScale(peak.count) - 10)
                    .attr("text-anchor", "middle")
                    .text(`Peak count: ${peak.count}`);

                // Add the x-axis
                svg.selectAll(".x-axis").data([0]).join("g")
                    .attr("class", "x-axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(xScale));

                // Add the y-axis
                svg.selectAll(".y-axis").data([0]).join("g")
                    .attr("class", "y-axis")
                    .call(d3.axisLeft(yScale));

                // Add axes labels
                svg.selectAll(".x-label").data(["Hour of the Day"]).join("text")
                    .attr("class", "x-label")
                    .attr("text-anchor", "end")
                    .attr("x", width / 2)
                    .attr("y", height + margin.top + 20)
                    .text(d => d);

                svg.selectAll(".y-label").data(["Count of Cars"]).join("text")
                    .attr("class", "y-label")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2)
                    .text(d => d);
            }

            updateChart([...carTypes][0]);
        });
    </script>
</body>

</html>